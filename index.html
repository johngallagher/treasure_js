<!DOCTYPE html>
<html>
<head>
  <title>Treasure JS Proof of Concept</title>
  <link href="css/application.css?body=1" media="all" rel="stylesheet" type="text/css">
  <link href="css/chosen.css?body=1" media="all" rel="stylesheet" type="text/css">
  <meta content="authenticity_token" name="csrf-param">
  <meta content="JeN23VMeqzt9GSvOwBWhr3Zo+qkV7gg89R7Fd2Qkvpo=" name="csrf-token">
</head>
<body>

  <h1>Treasure JS Proof of Concept</h1>

  <select id="query" multiple="multiple" name="query[]"></select>

  <div id="results">
  </div>


</body>
<script type="text/javascript" src='jquery/jquery.js'></script>
<script type="text/javascript" src='chosen/chosen.jquery.js'></script>
<script type="text/javascript" src='node_modules/backbone/node_modules/underscore/underscore.js'></script>
<script type="text/javascript" src='node_modules/backbone/backbone.js'></script>
<script type="text/javascript" src='node_modules/url-template/lib/url-template.js'></script>
<script type="text/javascript" src='node_modules/backbone.localstorage/backbone.localStorage.js'></script>

<script type="text/template" id="condition-group-template">
<% _.each( groups, function( thisGroup){  %>
  <optgroup label="<%= thisGroup[0].get('group') %>">
  <% _.each( thisGroup, function( thisItem ){ %>
    <option value="<%= thisItem.get('id') %>"<%= thisItem.selectedAttribute() %>><%= thisItem.get('text') %></option>
    <% }) %>
  </optgroup>
  <% }) %>
</script>

<script type="text/template" id="selected-conditions-template">
<h3>Selected Criteria</h3>
<% _.each( conditions, function( thisCondition){  %>
  <div><span><%= thisCondition.get('group') %></span> - <span><%= thisCondition.get('text') %></span></div>
  <% }) %>
</script>

<script type="text/template" id="results-template">
<h3>Results</h3>
<% _.each( schools, function( thisSchool){  %>
  <div>
  <a href="<%= thisSchool.get('item') %>"><%= thisSchool.get('name') %></a>
  </div>
  <% }) %>
</script>

<script type="text/javascript">
$( document ).ready(function() {

  var typeOfEstablishments = [{parameter: "typeOfEstablishment", group: "Type", text: "Other Independent School", value: "Other Independent School"},
{parameter: "typeOfEstablishment", group: "Type", text: "Voluntary Aided School", value: "Voluntary Aided School"},
{parameter: "typeOfEstablishment", group: "Type", text: "Foundation School", value: "Foundation School"},
{parameter: "typeOfEstablishment", group: "Type", text: "Community School", value: "Community School"},
{parameter: "typeOfEstablishment", group: "Type", text: "Other Independent Special School", value: "Other Independent Special School"},
{parameter: "typeOfEstablishment", group: "Type", text: "Community Special School", value: "Community Special School"},
{parameter: "typeOfEstablishment", group: "Type", text: "LA Nursery School", value: "LA Nursery School"},
{parameter: "typeOfEstablishment", group: "Type", text: "Pupil Referral Unit", value: "Pupil Referral Unit"},
{parameter: "typeOfEstablishment", group: "Type", text: "City Technology College", value: "City Technology College"},
{parameter: "typeOfEstablishment", group: "Type", text: "Voluntary Controlled School", value: "Voluntary Controlled School"},
{parameter: "typeOfEstablishment", group: "Type", text: "Independent School Approved for SEN Pupils", value: "Independent School Approved for SEN Pupils"},
{parameter: "typeOfEstablishment", group: "Type", text: "Foundation Special School", value: "Foundation Special School"},
{parameter: "typeOfEstablishment", group: "Type", text: "Miscellaneous", value: "Miscellaneous"},
{parameter: "typeOfEstablishment", group: "Type", text: "Non-Maintained Special School", value: "Non-Maintained Special School"},
{parameter: "typeOfEstablishment", group: "Type", text: "Academies", value: "Academies"},
{parameter: "typeOfEstablishment", group: "Type", text: "Legacy types", value: "Legacy types"},
{parameter: "typeOfEstablishment", group: "Type", text: "Playing for Success Centres", value: "Playing for Success Centres"},
{parameter: "typeOfEstablishment", group: "Type", text: "Further Education", value: "Further Education"},
{parameter: "typeOfEstablishment", group: "Type", text: "Institution funded by other Government Department", value: "Institution funded by other Government Department" },
{parameter: "typeOfEstablishment", group: "Type", text: "Service Childrens Education", value: "Service Childrens Education"},
{parameter: "typeOfEstablishment", group: "Type", text: "Secure Units", value: "Secure Units"},
{parameter: "typeOfEstablishment", group: "Type", text: "European Schools", value: "European Schools"},
{parameter: "typeOfEstablishment", group: "Type", text: "Offshore Schools", value: "Offshore Schools"},
{parameter: "typeOfEstablishment", group: "Type", text: "Sixth Form Centres", value: "Sixth Form Centres"},
{parameter: "typeOfEstablishment", group: "Type", text: "Special College", value: "Special College"},
{parameter: "typeOfEstablishment", group: "Type", text: "Higher Education Institutions", value: "Higher Education Institutions"},
{parameter: "typeOfEstablishment", group: "Type", text: "Welsh Establishment", value: "Welsh Establishment"},
{parameter: "typeOfEstablishment", group: "Type", text: "EY Setting", value: "EY Setting"}]




  // District Administratives
  var districtAdministratives = [{parameter: "districtAdministrative", group: "Location", text: "Southwark" , value: "Southwark"},
{parameter: "districtAdministrative", group: "Location", text: "Lambeth" , value: "Lambeth"},
{parameter: "districtAdministrative", group: "Location", text: "Westminster" , value: "Westminster"},
{parameter: "districtAdministrative", group: "Location", text: "Kensington and Chelsea" , value: "Kensington and Chelsea"},
{parameter: "districtAdministrative", group: "Location", text: "Wandsworth" , value: "Wandsworth"},
{parameter: "districtAdministrative", group: "Location", text: "Milton Keynes" , value: "Milton Keynes"},
{parameter: "districtAdministrative", group: "Location", text: "Thanet" , value: "Thanet"},
{parameter: "districtAdministrative", group: "Location", text: "Barking and Dagenham" , value: "Barking and Dagenham"},
{parameter: "districtAdministrative", group: "Location", text: "Barnet" , value: "Barnet"},
{parameter: "districtAdministrative", group: "Location", text: "Lewisham" , value: "Lewisham"},
{parameter: "districtAdministrative", group: "Location", text: "Bromley" , value: "Bromley"},
{parameter: "districtAdministrative", group: "Location", text: "Greenwich" , value: "Greenwich"},
{parameter: "districtAdministrative", group: "Location", text: "Tower Hamlets" , value: "Tower Hamlets"},
{parameter: "districtAdministrative", group: "Location", text: "Lewes" , value: "Lewes"},
{parameter: "districtAdministrative", group: "Location", text: "Bexley" , value: "Bexley"},
{parameter: "districtAdministrative", group: "Location", text: "Brent" , value: "Brent"},
{parameter: "districtAdministrative", group: "Location", text: "Enfield" , value: "Enfield"},
{parameter: "districtAdministrative", group: "Location", text: "Birmingham" , value: "Birmingham"},
{parameter: "districtAdministrative", group: "Location", text: "Waltham Forest" , value: "Waltham Forest"},
{parameter: "districtAdministrative", group: "Location", text: "Coventry" , value: "Coventry"},
{parameter: "districtAdministrative", group: "Location", text: "Solihull" , value: "Solihull"},
{parameter: "districtAdministrative", group: "Location", text: "Stratford-on-Avon" , value: "Stratford-on-Avon"},
{parameter: "districtAdministrative", group: "Location", text: "Bromsgrove" , value: "Bromsgrove"},
{parameter: "districtAdministrative", group: "Location", text: "Wirral" , value: "Wirral"},
{parameter: "districtAdministrative", group: "Location", text: "St. Helens" , value: "St. Helens"},
{parameter: "districtAdministrative", group: "Location", text: "Liverpool" , value: "Liverpool"},
{parameter: "districtAdministrative", group: "Location", text: "Knowsley" , value: "Knowsley"},
{parameter: "districtAdministrative", group: "Location", text: "Wolverhampton" , value: "Wolverhampton"},
{parameter: "districtAdministrative", group: "Location", text: "South Staffordshire" , value: "South Staffordshire"},
{parameter: "districtAdministrative", group: "Location", text: "Sefton" , value: "Sefton"},
{parameter: "districtAdministrative", group: "Location", text: "Telford and Wrekin" , value: "Telford and Wrekin"},
{parameter: "districtAdministrative", group: "Location", text: "Bolton" , value: "Bolton"},
{parameter: "districtAdministrative", group: "Location", text: "Bury" , value: "Bury"},
{parameter: "districtAdministrative", group: "Location", text: "Salford" , value: "Salford"},
{parameter: "districtAdministrative", group: "Location", text: "Manchester" , value: "Manchester"},
{parameter: "districtAdministrative", group: "Location", text: "Oldham" , value: "Oldham"},
{parameter: "districtAdministrative", group: "Location", text: "Macclesfield" , value: "Macclesfield"},
{parameter: "districtAdministrative", group: "Location", text: "Congleton" , value: "Congleton"},
{parameter: "districtAdministrative", group: "Location", text: "Chorley" , value: "Chorley"},
{parameter: "districtAdministrative", group: "Location", text: "Rochdale" , value: "Rochdale"},
{parameter: "districtAdministrative", group: "Location", text: "Stockport" , value: "Stockport"},
{parameter: "districtAdministrative", group: "Location", text: "High Peak" , value: "High Peak"},
{parameter: "districtAdministrative", group: "Location", text: "Trafford" , value: "Trafford"},
{parameter: "districtAdministrative", group: "Location", text: "Tameside" , value: "Tameside"},
{parameter: "districtAdministrative", group: "Location", text: "Wigan" , value: "Wigan"},
{parameter: "districtAdministrative", group: "Location", text: "Barnsley" , value: "Barnsley"},
{parameter: "districtAdministrative", group: "Location", text: "Doncaster" , value: "Doncaster"},
{parameter: "districtAdministrative", group: "Location", text: "Rotherham" , value: "Rotherham"},
{parameter: "districtAdministrative", group: "Location", text: "Sheffield" , value: "Sheffield"},
{parameter: "districtAdministrative", group: "Location", text: "Bradford" , value: "Bradford"},
{parameter: "districtAdministrative", group: "Location", text: "Leeds" , value: "Leeds"},
{parameter: "districtAdministrative", group: "Location", text: "Harrogate" , value: "Harrogate"},
{parameter: "districtAdministrative", group: "Location", text: "Calderdale" , value: "Calderdale"},
{parameter: "districtAdministrative", group: "Location", text: "Kirklees" , value: "Kirklees"},
{parameter: "districtAdministrative", group: "Location", text: "North Tyneside" , value: "North Tyneside"},
{parameter: "districtAdministrative", group: "Location", text: "North Somerset" , value: "North Somerset"},
{parameter: "districtAdministrative", group: "Location", text: "Bath and North East Somerset" , value: "Bath and North East Somerset"},
{parameter: "districtAdministrative", group: "Location", text: "Aberdeen City" , value: "Aberdeen City"}]


  // Config
  var paramTemplate = urltemplate.parse(' ?___{key} rdfs:label "{value}" . ?item {namespace}:{key} ?___{key} .');
  var tupleTemplate = urltemplate.parse(' {object_1} {relationship} {object_2} . ');
  var prefixes = 'PREFIX rdf: <http://www.w3.org/1999/02/22-rdf-syntax-ns#> PREFIX rdfs: <http://www.w3.org/2000/01/rdf-schema#> PREFIX school: <http://education.data.gov.uk/def/school/>';
  var select = ' SELECT ?name ?item';
  var where  = ' WHERE { ?item rdf:type school:School . ?item rdfs:label ?name .';
  var limit  = ' } OFFSET 0 LIMIT 30';
  var base_url = 'http://education.data.gov.uk/sparql/education/query?query=';


  var app = app || {};

  app.Condition = Backbone.Model.extend({
    defaults: function() {
      return {
        group: null,
        selected: false,
        selectable: true
      };
    },
    select: function() {
      this.save({selected: true});
    },
    deselect: function() {
      this.save({selected: false});
    },
    selectedAttribute: function() {
      if (this.get('selected')) {
        return " selected";
      } else {
        return "";
      }
    }
  });

  var ConditionList = Backbone.Collection.extend({
    model: app.Condition,
    localStorage: new Backbone.LocalStorage("conditions-backbone"),
    comparator: 'text',
    selectable: function() {
      return this.filter(function(condition) {
        return condition.get('selectable');
      });
    },
    selected: function() {
      return this.where({selected: true});
    },
    selectedCount: function() {
      return selected().length;
    },
    allowGroup: function(group) {
      this.forEach(function(condition) {
        if(condition.get('group') == group || condition.get('selected')) {
          condition.set('selectable', true);
        } else {
          condition.set('selectable', false)
        };
        condition.save();
      });
    },
    select: function(id) {
      selectedCondition = app.Conditions.findWhere({id: id});
      selectedCondition.select();
      selectedGroup = selectedCondition.get('group');
      this.allowGroup(this.nextGroupAllowed(selectedGroup));
    },
    nextGroupAllowed: function(selectedGroup) {
        if (selectedGroup == "Phase") {
          return "Location";
        } else if (selectedGroup == "Location") {
          return "Type";
        } else if (selectedGroup == "Type") {
          return "";
        } else {
          return "";
        }
    },
    deselect: function (id) {
      deselectedCondition = app.Conditions.findWhere({id: id});
      deselectedCondition.deselect();
      deselectedGroup = deselectedCondition.get('group');
      this.allowGroup(deselectedGroup);
    },
    updateAll: function() {
      var collection = this;
      options = {
        success: function(model, resp, xhr) {
          collection.reset(model);
        }
      };
      return Backbone.sync('update', this, options);
    },
    saveAll: function() {
      Backbone.sync('save', this, {
        success: function(){
          console.log('users saved!');
        } 
      })
    }
  });

  app.Conditions = new ConditionList();

  app.ConditionGroupView = Backbone.View.extend({
    template: _.template($("#condition-group-template").html()),

     initialize: function () {
       this.listenTo(app.Conditions, 'add', this.add);
     },

     add: function(condition) {
       condition.save();
     },
    render: function() {
      var selectable = app.Conditions.selectable();
      var groups = _.groupBy(selectable, function(object) { return object.get('group') });
      this.el = this.template({groups: groups});
      $('#query').children().remove();
      $('#query').append(this.el);
      $('#query').trigger('chosen:updated');
      return this;
    },
  });

  app.SelectedConditionsGroupView = Backbone.View.extend({
    template: _.template($("#selected-conditions-template").html()),
    conditions: function() {
      return app.Conditions.where({selected: true});
    },
    render: function() {
      $('#results').html(this.template({conditions: this.conditions}));
    },
  });

  var SchoolList = Backbone.Collection.extend({
    url: function() {
      selectedConditions = app.Conditions.where({selected: true});
      encodedPrefixes = encodeURIComponent(prefixes)
      encodedSelect   = encodeURIComponent(select)
      encodedWhere    = encodeURIComponent(where);
      encodedLimit    = encodeURIComponent(limit);
      encodedSearchParameters = selectedConditions.map(function(condition) { 
        return paramTemplate.expand({
          key: condition.get('parameter'), 
          namespace: "school", 
          value: condition.get('value')
        });
      }).join(" ");
      encodedFormat   = '&output=json&stylesheet=xml-to-html.xsl&force-accept=text%2Fplain';

      return base_url + encodedPrefixes + encodedSelect + encodedWhere + encodedSearchParameters + encodedLimit + encodedFormat;
    },
    parse: function (raw_response) {
      console.log("just parsed");
      data = raw_response.results.bindings.map(function(result) { 
        return {"item":result.item.value, "name":result.name.value}; 
      });
      return data;
    },
    update: function() {
      this.fetch({ 
        dataType: "jsonp",
        success: (function(data) {
          app.schoolsView.render();
        }),
        error: (function(data) {
          console.log("Error");
        }),
        complete: (function(data) {
          console.log("Complete");
        })
      });
    }
  });
  app.schools = new SchoolList();

  SchoolsView = Backbone.View.extend({
    template: _.template($('#results-template').html()),
    render: function() {
      $('#results').html(this.template({schools: app.schools.toArray()}));
    }
  })

  app.conditionsGroupView = new app.ConditionGroupView(); // Start the conditions view
  app.selectedConditionsView = new app.SelectedConditionsGroupView();
  app.schoolsView = new SchoolsView();

  app.Conditions.add([
    {parameter: "phaseOfEducation", group: "Phase", text: "Primary", value: "Primary"},
    {parameter: "phaseOfEducation", group: "Phase", text: "Secondary", value: "Secondary"}
    ]);
  app.Conditions.add(districtAdministratives);
  app.Conditions.add(typeOfEstablishments);

  app.conditionsGroupView.render();

  $('#query').chosen();
  app.schools.update();

  $('#query').on('change', function(evt, params) {
    conditionWasSelected = params.selected != null;
    if (conditionWasSelected) {
      app.Conditions.select(params.selected);
    } else {
      app.Conditions.deselect(params.deselected);
    };
    app.conditionsGroupView.render();
    
    app.schools.update();
  });

});


</script>
</html>
