<!DOCTYPE html>
<html>
<head>
  <title>Treasure JS Proof of Concept</title>
  <link href="css/application.css?body=1" media="all" rel="stylesheet" type="text/css">
  <link href="css/chosen.css?body=1" media="all" rel="stylesheet" type="text/css">
  <link href="select2/select2.css" media="all" rel="stylesheet" type="text/css">
  <meta content="authenticity_token" name="csrf-param">
  <meta content="JeN23VMeqzt9GSvOwBWhr3Zo+qkV7gg89R7Fd2Qkvpo=" name="csrf-token">
  <style type="text/css">.select2-container { width: 100% }</style>
</head>
<body>
  <h1>Treasure JS Proof of Concept</h1>
  <input id="query2" name="query[]"></input>
  <div id="results"></div>
</body>

<script type="text/javascript" src='jquery/jquery.js'></script>
<script type="text/javascript" src='select2/select2.js'></script>

<script type="text/javascript" src='node_modules/backbone/node_modules/underscore/underscore.js'></script>
<script type="text/javascript" src='node_modules/backbone/backbone.js'></script>
<script type="text/javascript" src='node_modules/backbone.localstorage/backbone.localStorage.js'></script>
<script type="text/javascript" src='node_modules/query-engine/out/lib/query-engine.js'></script>
<script type="text/javascript" src='node_modules/backbone-relational/backbone-relational.js'></script>
<script type="text/javascript" src='node_modules/backbone-query/js/backbone-query.js'></script>
<script type="text/javascript" src='default_data_relational.js'></script>

<script type="text/javascript">
Criteria = Backbone.RelationalModel.extend({
  defaults: function() {
    return {
      selected: false,
      orderSelected: 0
    };
  },
  select: function() {
    this.set('orderSelected', app.Conditions.selectedCount() + 1);
    this.save({selected: true});
  },
  deselect: function() {
    this.set('orderSelected', 0);
    this.save({selected: false});
  }
});

CriteriaList = Backbone.QueryCollection.extend({
  model: Criteria,
  localStorage: new Backbone.LocalStorage("conditions-backbone")
});

CriteriaGroup = Backbone.RelationalModel.extend({
  relations: [{
    type: Backbone.HasMany,
    key: 'children',
    relatedModel: 'Criteria',
    collectionType: 'CriteriaList',
    includeInJSON: 'Backbone.Model.prototype.idAttribute',
    reverseRelation: {
      key: 'parent',
      includeInJSON: 'Backbone.Model.prototype.idAttribute'
    }
  }]
});

CriteriaGroupList = Backbone.QueryCollection.extend({
  model: CriteriaGroup,
  localStorage: new Backbone.LocalStorage("conditions-backbone"),
  queryFor: function(term) {
  }
});

$( document ).ready(function() {
  var criteriaGroupList = new CriteriaGroupList();
  criteriaGroupList.fetch();

  if (criteriaGroupList.length == 0) {
    criteriaGroupList.create(bulk_data[0]);
    criteriaGroupList.create(bulk_data[1]);
    criteriaGroupList.create(bulk_data[2]);
  };

  $('#query2').select2({
    multiple: true,
    query: function (query) {
      query.term = "Southwark";
      data = criteriaGroupList.toArray().map(function(group) {
        thisGroupsQueriedChildren = new CriteriaList(group.get('children').query({text: "Other Independent School"}));
        return { text: group.get('text'), children: thisGroupsQueriedChildren.toJSON() };
      });

      query.callback({results: criteriaGroupList.toJSON() });
    }
  });
});

</script>
</html>
