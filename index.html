<!DOCTYPE html>
<html>
<head>
  <title>Treasure JS Proof of Concept</title>
  <link href="css/application.css?body=1" media="all" rel="stylesheet" type="text/css">
  <link href="css/chosen.css?body=1" media="all" rel="stylesheet" type="text/css">
  <link href="select2/select2.css" media="all" rel="stylesheet" type="text/css">
  <meta content="authenticity_token" name="csrf-param">
  <meta content="JeN23VMeqzt9GSvOwBWhr3Zo+qkV7gg89R7Fd2Qkvpo=" name="csrf-token">
  <script type="text/javascript" src='jquery/jquery.js'></script>
  <script type="text/javascript" src='select2/select2.js'></script>

  <script type="text/javascript" src='node_modules/backbone/node_modules/underscore/underscore.js'></script>
  <script type="text/javascript" src='node_modules/backbone/backbone.js'></script>
  <script type="text/javascript" src='node_modules/backbone.localstorage/backbone.localStorage.js'></script>
  <script type="text/javascript" src='node_modules/query-engine/out/lib/query-engine.js'></script>
  <script type="text/javascript" src='node_modules/backbone-relational/backbone-relational.js'></script>
  <script type="text/javascript" src='node_modules/backbone-query/js/backbone-query.js'></script>
  <script type="text/javascript" src='default_data_relational.js'></script>
  <style type="text/css">
  .select2-container { 
    width: 100%; 
  }
  .bigdrop, .select2-results { 
    max-height: 310px;
  }
  </style>
</head>
<body>
  <h1>Treasure JS Proof of Concept</h1>
  <input id="query2" name="query[]"></input>
  <div id="results"></div>
</body>


<script type="text/javascript">
Criteria = Backbone.RelationalModel.extend({
  defaults: function() {
    return {
      selected: false,
      orderSelected: 0
    };
  },
  select: function() {
    this.set('orderSelected', app.Conditions.selectedCount() + 1);
    this.save({selected: true});
  },
  deselect: function() {
    this.set('orderSelected', 0);
    this.save({selected: false});
  }
});

CriteriaList = Backbone.QueryCollection.extend({
  model: Criteria,
  localStorage: new Backbone.LocalStorage("conditions-backbone")
});

CriteriaGroup = Backbone.RelationalModel.extend({
  relations: [{
    type: Backbone.HasMany,
    key: 'children',
    relatedModel: 'Criteria',
    collectionType: 'CriteriaList',
    includeInJSON: true,
    createModels: true,
    reverseRelation: {
      key: 'parent',
      includeInJSON: true
    }
  }]
});

CriteriaGroupList = Backbone.QueryCollection.extend({
  model: CriteriaGroup,
  localStorage: new Backbone.LocalStorage("conditions-backbone"),
  initialize: function() {
    this.on("add", function (group) {
      group.get('children').each(function (child) {
        if (child.isNew()) {
          child.save();
        };
      });
    });
  },
  queryFor: function(term) {
  }
});

$( document ).ready(function() {
  var criteriaGroupList = new CriteriaGroupList();
  criteriaGroupList.fetch({wait: true});

  if (criteriaGroupList.length == 0) {
    _.each(bulk_data, function(group) {
      criteriaGroupList.create(group);
    });

    criteriaGroupList.fetch({wait: true});
  };

  $('#query2').select2({
    multiple: true,
    dropdownCssClass: "bigdrop",
    query: function (query) {
      dataWithNulls = criteriaGroupList.map(function(group, key, list) {
        matchingChildren = group.get('children').query({
          text: { 
            $cb: function(attr) { 
              return attr.toUpperCase().indexOf(query.term.toUpperCase())>=0; 
            } 
          } 
        });
        if (matchingChildren.length == 0) {
          return null;
        } else {
          if (matchingChildren.length > 2) {
            firstThreeChildren = _.first(matchingChildren, 2)
            loadMoreFooter = {id: "NA", text: (matchingChildren.length - 2) + " more..."};
            matchingChildren = _.union(firstThreeChildren, [loadMoreFooter]);
          };
          thisGroupsQueriedChildren = new CriteriaList(matchingChildren);
          return { text: group.get('text'), children: thisGroupsQueriedChildren.toJSON() };
        }
      });

      data = _.select(dataWithNulls, function(group) { return group != null; })

      query.callback({results: data });
    }
  });
});

</script>
</html>
